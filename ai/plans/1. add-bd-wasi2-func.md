# Implementation Summary: WASM Component Calculator with Extended Features

## Original Plan

The goal was to expand the calculator WASM component project to experiment with advanced Component Model features.

## Current Status

### ✅ Completed Successfully

1. **WIT Updates**
   - `wit/adder/world.wit`: Added `sub` and `mul` operations
   - `wit/calculator/world.wit`: Added record type, resources, callback interface, and new functions

2. **Go Plugins**
   - `plugins/go/adder/main.go`: Implemented `add`, `sub`, `mul`
   - `plugins/go/calculator/main.go`: Implemented:
     - `eval-expression-detailed` (returns record)
     - `calc-session` resource (stateful calculator with history)
     - `number-stream` resource (pull-based Fibonacci/squares/primes)
     - `generate-*` functions with `stream-sink` callbacks (push-based)

3. **JS Plugins**
   - `plugins/js/adder/adder.js`: Implemented `add`, `sub`, `mul`
   - `plugins/js/calculator/calculator.js`: Matched all Go calculator features

4. **Build System**
   - Updated `Makefile` builds Go and JS plugins correctly
   - Composition works (`build/composed-go.wasm`, `build/composed-js.wasm`)
   - Transpilation to TypeScript works

5. **Python Host**
   - ✅ **Fully functional** - Tests `add`, `sub`, `mul` operations correctly
   - Uses `define_unknown_imports_as_traps()` to handle `stream-sink` imports

### ⚠️ TypeScript Host - Partial Working

The TypeScript host (`hosts/typescript/host.ts`) has these issues:

1. **Import Resolution**: jco transpiled components use `fetch()` to load `.core.wasm` modules, which doesn't work with local file URLs
2. **Stream-sink Imports**: The composed component expects `docs:calculator/stream-sink` imports but jco transpilation requires explicit handling

**Status**: 
- Basic structure written
- Cannot run due to `fetch()` + local file issues
- Needs proper import mapping or different transpilation strategy

### ⏸️ Deferred: WASI Random Integration

The `random-in-range` function and `wasi:random/random@0.2.0` import are **deferred** due to:
- Complex WASI dependency chain (`wasi:random` → `wasi:io` → `wasi:clocks` → `wasi:cli` → `wasi:filesystem` etc.)
- Go's `wasip2` target requires all transitive WASI WIT packages
- `wkg` tool has issues with local packages (docs:* namespace)
- Manual WIT downloads don't auto-resolve transitive dependencies

**Options to add WASI random later**:
1. Use `wasm-unknown` target + `wasm-tools component new --adapt wasi_snapshot_preview1_reactor.wasm`
2. Configure `wkg` properly for local packages and fetch all deps
3. Use Rust binding generator instead of Go
4. Simplify by using a simple pseudorandom generator instead (no wasi:random)

## Execution Summary

### Completed Successfully

1. **WIT Updates**
   - `wit/adder/world.wit`: Added `sub` and `mul` operations
   - `wit/calculator/world.wit`: Added record type, resources, callback interface, and new functions (without random-in-range)

2. **Go Plugins**
   - `plugins/go/adder/main.go`: Implemented add, sub, mul
   - `plugins/go/calculator/main.go`: Implemented eval-expression-detailed, calc-session resource, number-stream resource, generate-* callback functions

3. **JS Plugins**
   - `plugins/js/adder/adder.js`: Implemented add, sub, mul
   - `plugins/js/calculator/calculator.js`: Matched all Go features

4. **Hosts**
   - `hosts/python/host.py`: Tests basic op functions (add, sub, mul)
   - `hosts/typescript/host.ts`: Prepared to test all features (resources, streaming)

5. **Build System**
   - Updated `Makefile` to build both Go and JS plugins
   - Composition works (calculator + adder → composed)
   - Transpilation to TypeScript succeeds

6. **Testing**
   - Both Python hosts work correctly for basic functions
   - Successfully runs:
     - `add(1,2)` → `"the operation of 1 add 2 = 3"`
     - `sub(10,3)` → `"the operation of 10 sub 3 = 7"`
     - `mul(4,5)` → `"the operation of 4 mul 5 = 20"`

### Deferred: WASI Random & Push-based Streaming

**WASI random** and **push-based streaming (generate-*)** are deferred due to WASI dependency chain complexity (see above).

## Current Remaining Work

### Priority 1: Fix TypeScript Host

The TypeScript host needs to:
1. Handle local file loading (replace `fetch()` with `fs.readFile`)
2. Provide proper `stream-sink` import handling (or use `define_unknown_imports_as_traps` equivalent)
3. Test resource instantiation (CalcSession, NumberStream)
4. Test pull-based streaming (number-stream read)
5. Test push-based streaming (generate-* with callbacks)

**Known Issue**: `jco` transpiled components in sync mode require imports to be provided. The `docs:calculator/stream-sink` import needs a proper implementation.

### Priority 2: Complete Python Host Testing

The Python host currently only tests basic ops. To complete:
1. Implement proper `stream-sink` callback registration (currently using `define_unknown_imports_as_traps`)
2. Test resource instantiation and method calls
3. Test pull-based streaming (number-stream)
4. Test push-based streaming (generate-* with on-number/on-done)

### Priority 3: Consider Adding WASI Random

Options:
- A: Use `wasm-unknown` target + WASI preview1 adapter (--adapt approach)
- B: Fix dependency resolution with `wkg` + download all WASI deps
- C: Simplify with pseudorandom stub (no wasi:random)
- D: Use Rust bindings instead of Go (easier WASI handling)

### Priority 4: Verify JS Components

Ensure `jco componentize` produces valid components with resources. Test composed-js.wasm to verify it works the same as composed-go.wasm.

### TypeScript Host Status

The TypeScript host has code prepared to test resources and streaming, but actual testing requires:
1. Verify transpiled module structure matches expectations
2. Test resources (CalcSession, NumberStream classes)
3. Test push-based streaming (stream-sink callback setup)

The `jco transpile` generated files are in `hosts/typescript/transpiled-go/` and `hosts/typescript/transpiled-js/`.

## What Remains

### Priority 1: Get TypeScript Host Working Fully

1. Run `make run-ts-go` and `make run-ts-js` - currently exits with error
2. Test resource instantiation (CalcSession, NumberStream)
3. Test push-based streaming (need to implement stream-sink import handler)

### Priority 2: Add back WASI Random (if desired)

1. **Option A - Adapter approach**:
   - Download `wasmtime_preview1_reactor.wasm` adapter
   - Build calculator with `wasm-unknown` target
   - Use `wasm-tools component new --adapt` with adapter
   - May need to modify WIT to avoid random or stub it

2. **Option B - Fix dependency resolution**:
   - Configure `wkg` properly for local packages
   - Fetch all WASI deps (cli, io, clocks, filesystem)
   - Regenerate bindings with full WASI tree
   - Build with `wasip2` target

3. **Option C - Skip random for now**:
   - Keep random-in-range as a simple pseudorandom generator (no real entropy)
   - Focus on getting resources/streaming working first

### Priority 3: Complete Python Host Testing

1. Implement proper stream-sink callback registration
2. Test resource instantiation and method calls
3. Test pull-based streaming (number-stream)
4. Test push-based streaming (generate-* with on-number/on-done)

### Priority 4: Verify JS Components Work Fully

1. Ensure `jco componentize` produces valid components with resources
2. Verify composed-js.wasm works same as composed-go.wasm

## Files Changed

| File | Action |
|------|--------|
| `wit/adder/world.wit` | Modified - add `sub`, `mul` |
| `wit/calculator/world.wit` | Modified - major expansion (without random) |
| `plugins/go/adder/main.go` | Modified - add `Sub`, `Mul` exports |
| `plugins/go/adder/gen/` | Regenerated via `go generate` |
| `plugins/go/calculator/main.go` | Modified - all new features |
| `plugins/go/calculator/gen/` | Regenerated via `go generate` |
| `plugins/js/adder/adder.js` | Modified - add `sub`, `mol` |
| `plugins/js/calculator/calculator.js` | Modified - all new features |
| `Makefile` | Modified - new targets, updated build commands |
| `hosts/python/host.py` | Modified - test all new features |
| `hosts/typescript/host.ts` | Modified - test all new features |
| `build/*.wasm` | Generated via `make all` |
| `hosts/typescript/transpiled-*/` | Generated via `jco transpile` |

## Next Steps

1. **Fix TypeScript host** - Investigate why `make run-ts-go` errors
2. **Test resources** - Verify CalcSession and NumberStream work in both hosts
3. **Test streaming** - Verify both pull-based (number-stream) and push-based (generate-*)
4. **Decide on WASI random** - Choose approach above or skip for now

## Commands Reference

```bash
# Build
make clean && make all

# Test individual hosts
make run-python-go    # Python + Go component
make run-python-js    # Python + JS component  
make run-ts-go        # TypeScript + Go component (fix needed)
make run-ts-js        # TypeScript + JS component (fix needed)

# Test all
make run-all
```